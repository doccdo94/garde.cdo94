<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Gardes CDO 94</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 16px;
        }

        /* Statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        /* Tableau */
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .table-header h2 {
            color: #1f2937;
            font-size: 24px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Groupes de dates */
        .date-group {
            margin-bottom: 30px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .date-group-header {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .date-group-header h3 {
            color: #1f2937;
            font-size: 20px;
        }

        .status-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-complete {
            background: #10b981;
            color: white;
        }

        .status-partial {
            background: #f59e0b;
            color: white;
        }

        .status-empty {
            background: #6b7280;
            color: white;
        }

        /* Liste des praticiens */
        .practitioners-list {
            padding: 20px;
        }

        .practitioner-card {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .practitioner-info {
            flex: 1;
        }

        .practitioner-info h4 {
            color: #1f2937;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .practitioner-info p {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .practitioner-actions {
            margin-left: 20px;
        }

        /* Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message.success {
            background: #10b981;
            color: white;
        }

        .message.error {
            background: #ef4444;
            color: white;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .practitioner-card {
                flex-direction: column;
            }

            .practitioner-actions {
                margin-left: 0;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- En-t√™te -->
        <div class="header">
            <h1>üè• Administration des Gardes</h1>
            <p>Conseil D√©partemental de l'Ordre des Chirurgiens-Dentistes du Val-de-Marne</p>
        </div>

        <!-- Statistiques -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Gardes Compl√®tes</h3>
                <div class="number" id="stat-completes">-</div>
            </div>
            <div class="stat-card">
                <h3>Gardes Partielles</h3>
                <div class="number" id="stat-partielles">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Inscriptions</h3>
                <div class="number" id="stat-total">-</div>
            </div>
            <div class="stat-card">
                <h3>Dates Disponibles</h3>
                <div class="number" id="stat-disponibles">-</div>
            </div>
        </div>

        <!-- Tableau des inscriptions -->
        <div class="table-container">
            <div class="table-header">
                <h2>üìã Inscriptions par date</h2>
                <button class="btn btn-primary" onclick="rafraichir()">
                    üîÑ Rafra√Æchir
                </button>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Chargement des donn√©es...</p>
            </div>

            <div id="inscriptions-container" style="display: none;">
                <!-- Les groupes de dates seront ins√©r√©s ici -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        // Chargement initial
        document.addEventListener('DOMContentLoaded', () => {
            chargerDonnees();
        });

        // Charger toutes les donn√©es
        async function chargerDonnees() {
            try {
                // Charger les inscriptions
                const responseInscriptions = await fetch(`${API_URL}/api/inscriptions`);
                const inscriptions = await responseInscriptions.json();

                // Charger les statistiques
                const responseStats = await fetch(`${API_URL}/api/stats`);
                const stats = await responseStats.json();

                // Charger les dates disponibles
                const responseDates = await fetch(`${API_URL}/api/dates-disponibles`);
                const datesDisponibles = await responseDates.json();

                afficherStatistiques(stats, datesDisponibles);
                afficherInscriptions(inscriptions);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('inscriptions-container').style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                afficherErreur('Impossible de charger les donn√©es');
            }
        }

        // Afficher les statistiques
        function afficherStatistiques(stats, datesDisponibles) {
            document.getElementById('stat-completes').textContent = stats.gardes_futures_completes || 0;
            document.getElementById('stat-partielles').textContent = stats.gardes_futures_partielles || 0;
            document.getElementById('stat-total').textContent = stats.total_inscriptions || 0;
            document.getElementById('stat-disponibles').textContent = datesDisponibles.length || 0;
        }

        // Afficher les inscriptions group√©es par date
        function afficherInscriptions(inscriptions) {
            const container = document.getElementById('inscriptions-container');
            container.innerHTML = '';

            if (inscriptions.length === 0) {
                container.innerHTML = '<p class="loading">Aucune inscription pour le moment.</p>';
                return;
            }

            // Grouper par date
            const parDate = {};
            inscriptions.forEach(ins => {
                const dateStr = ins.date_garde.split('T')[0];
                if (!parDate[dateStr]) {
                    parDate[dateStr] = [];
                }
                parDate[dateStr].push(ins);
            });

            // Trier les dates (les plus r√©centes en premier)
            const datesSortees = Object.keys(parDate).sort((a, b) => new Date(b) - new Date(a));

            // Cr√©er un groupe pour chaque date
            datesSortees.forEach(dateStr => {
                const praticiens = parDate[dateStr];
                const nbPraticiens = praticiens.length;
                
                const dateObj = new Date(dateStr + 'T00:00:00');
                const dateFormatee = formatDateFr(dateObj);

                let statut = '';
                let statusClass = '';
                if (nbPraticiens === 2) {
                    statut = 'Compl√®te (2/2)';
                    statusClass = 'status-complete';
                } else if (nbPraticiens === 1) {
                    statut = 'Partielle (1/2)';
                    statusClass = 'status-partial';
                }

                const groupHtml = `
                    <div class="date-group">
                        <div class="date-group-header">
                            <h3>üìÖ ${dateFormatee}</h3>
                            <span class="status-badge ${statusClass}">${statut}</span>
                        </div>
                        <div class="practitioners-list">
                            ${praticiens.map(p => creerCartePraticien(p)).join('')}
                        </div>
                    </div>
                `;

                container.innerHTML += groupHtml;
            });
        }

        // Cr√©er une carte pour un praticien
        function creerCartePraticien(praticien) {
            return `
                <div class="practitioner-card">
                    <div class="practitioner-info">
                        <h4>Dr ${praticien.praticien_nom} ${praticien.praticien_prenom}</h4>
                        <p><strong>Email :</strong> ${praticien.praticien_email}</p>
                        <p><strong>T√©l√©phone :</strong> ${praticien.praticien_telephone}</p>
                        <p><strong>RPPS :</strong> ${praticien.praticien_rpps}</p>
                        <p><strong>Adresse :</strong> ${praticien.praticien_numero} ${praticien.praticien_voie}, ${praticien.praticien_code_postal} ${praticien.praticien_ville}</p>
                        ${praticien.praticien_etage ? `<p><strong>√âtage :</strong> ${praticien.praticien_etage}</p>` : ''}
                        ${praticien.praticien_code_entree ? `<p><strong>Code d'entr√©e :</strong> ${praticien.praticien_code_entree}</p>` : ''}
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 10px;">
                            Inscrit le ${new Date(praticien.created_at).toLocaleDateString('fr-FR')} √† ${new Date(praticien.created_at).toLocaleTimeString('fr-FR')}
                        </p>
                    </div>
                    <div class="practitioner-actions">
                        <button class="btn btn-danger" onclick="supprimerInscription(${praticien.id}, '${praticien.praticien_nom}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                </div>
            `;
        }

        // Supprimer une inscription
        async function supprimerInscription(id, nom) {
            if (!confirm(`Voulez-vous vraiment supprimer l'inscription de Dr ${nom} ?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/inscriptions/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la suppression');
                }

                afficherSucces('Inscription supprim√©e avec succ√®s');
                rafraichir();

            } catch (error) {
                console.error('Erreur:', error);
                afficherErreur('Impossible de supprimer l\'inscription');
            }
        }

        // Rafra√Æchir les donn√©es
        function rafraichir() {
            document.getElementById('inscriptions-container').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            chargerDonnees();
        }

        // Formater une date en fran√ßais
        function formatDateFr(date) {
            const jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
            const mois = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 
                          'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
            
            return `${jours[date.getDay()]} ${date.getDate()} ${mois[date.getMonth()]} ${date.getFullYear()}`;
        }

        // Messages
        function afficherSucces(message) {
            const div = document.createElement('div');
            div.className = 'message success';
            div.textContent = '‚úÖ ' + message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function afficherErreur(message) {
            const div = document.createElement('div');
            div.className = 'message error';
            div.textContent = '‚ùå ' + message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }
    </script>
</body>
</html>
